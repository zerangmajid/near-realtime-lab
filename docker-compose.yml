services:
  kafka:
    image: data-forge-kafka:latest
    ports:
      - "19092:9092"
    volumes:
      - kafka-data:/bitnami/kafka
    environment:
      KAFKA_CFG_NODE_ID: "0"
      KAFKA_CFG_PROCESS_ROLES: "broker,controller"
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: "0@kafka:9093"
      KAFKA_CFG_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093"
      KAFKA_CFG_ADVERTISED_LISTENERS: "PLAINTEXT://kafka:9092"
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "true"
    healthcheck:
      test: ["CMD", "bash", "-lc", "echo > /dev/tcp/localhost/9092"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    restart: unless-stopped
    networks: [labnet]

  schema-registry:
    image: data-forge-schema-registry:latest
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "18081:8081"
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: PLAINTEXT://kafka:9092
    restart: unless-stopped
    networks: [labnet]

  kafka-ui:
    image: data-forge-kafka-ui:latest
    depends_on:
      kafka:
        condition: service_healthy
      schema-registry:
        condition: service_started
    ports:
      - "18082:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAP_SERVERS: kafka:9092
      KAFKA_CLUSTERS_0_SCHEMA_REGISTRY: http://schema-registry:8081
    restart: unless-stopped
    networks: [labnet]

  minio:
    image: data-forge-minio:latest
    ports:
      - "19000:9000"
      - "19001:9001"
    volumes:
      - minio-data:/data
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
      MINIO_PROMETHEUS_AUTH_TYPE: public
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s
    restart: unless-stopped
    networks: [labnet]

  # ✅ One-shot init container to create bucket(s) automatically
  minio-init:
    image: data-forge-minio:latest
    depends_on:
      minio:
        condition: service_healthy
    volumes:
      - ./minio/init:/init:ro
    entrypoint: ["/bin/sh", "-c", "/init/create-buckets.sh"]
    environment:
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-http://minio:9000}
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
      MINIO_BUCKET: ${MINIO_BUCKET:-raw-events}
    restart: "no"
    networks: [labnet]

  clickhouse:
    image: data-forge-clickhouse:latest
    ports:
      - "18123:8123"   # HTTP
      - "19002:9000"   # Native
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - ./clickhouse/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    restart: unless-stopped
    networks: [labnet]

  mock-api:
    build: ./mock-api
    ports:
      - "8000:8000"
    restart: unless-stopped
    networks: [labnet]

  producer:
    build: ./producer
    depends_on:
      kafka:
        condition: service_healthy
      schema-registry:
        condition: service_started
      mock-api:
        condition: service_started
    environment:
      KAFKA_BROKERS: kafka:9092
      SCHEMA_REGISTRY_URL: http://schema-registry:8081
      KAFKA_TOPIC: events.v1
      API_URL: http://mock-api:8000/event
      PRODUCER_POLL_SECONDS: "1"
    restart: unless-stopped
    networks: [labnet]
    extra_hosts:
      - "host.docker.internal:host-gateway"

  consumer:
    build: ./consumer
    depends_on:
      kafka:
        condition: service_healthy
      schema-registry:
        condition: service_started
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
      clickhouse:
        condition: service_healthy
    environment:
      KAFKA_BROKERS: kafka:9092
      SCHEMA_REGISTRY_URL: http://schema-registry:8081
      KAFKA_TOPIC: events.v1

      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-http://minio:9000}
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
      MINIO_BUCKET: ${MINIO_BUCKET:-raw-events}

      CLICKHOUSE_HOST: clickhouse
      CLICKHOUSE_HTTP_PORT: "8123"
      CLICKHOUSE_USER: admin
      CLICKHOUSE_PASSWORD: admin
      CLICKHOUSE_DB: analytics

      CONSUMER_FLUSH_SECONDS: "5"
    restart: unless-stopped
    networks: [labnet]
    extra_hosts:
      - "host.docker.internal:host-gateway"
  # ----------------------------
  # Observability (Prometheus + Grafana)
  # ----------------------------

  prometheus:
    image: prom/prometheus:v2.54.1
    ports:
      - "19090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.enable-lifecycle"
    restart: unless-stopped
    networks: [labnet]

  grafana:
    image: grafana/grafana:11.2.0
    ports:
      - "13000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_AUTH_ANONYMOUS_ENABLED: "false"
    depends_on:
      - prometheus
    restart: unless-stopped
    networks: [labnet]

  # Kafka Exporter (برای متریک‌های Kafka topic/consumer group)
  kafka-exporter:
    image: danielqsj/kafka-exporter:v1.7.0
    command:
      - "--kafka.server=kafka:9092"
    ports:
      - "19308:9308"
    depends_on:
      kafka:
        condition: service_healthy
    restart: unless-stopped
    networks: [labnet]

  # ClickHouse Exporter (برای متریک‌های ClickHouse)
  clickhouse-exporter:
    image: f1yegor/clickhouse-exporter:latest
    environment:
      CLICKHOUSE_URL: http://clickhouse:8123
      CLICKHOUSE_USER: admin
      CLICKHOUSE_PASSWORD: admin
    ports:
      - "19116:9116"
    depends_on:
      clickhouse:
        condition: service_healthy
    restart: unless-stopped
    networks: [labnet]


networks:
  labnet:

volumes:
  kafka-data:
  minio-data:
  clickhouse-data:
  prometheus-data:
  grafana-data:
